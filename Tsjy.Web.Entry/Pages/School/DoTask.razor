@page "/School/DoTask/{TaskId:long}"
@inherits BootstrapComponentBase
@using Tsjy.Application.System.Dtos
@using Tsjy.Core.Enums
@attribute [Authorize(Roles = "SchoolUser")]

<PageTitle>任务填报</PageTitle>

<div class="row g-0 page-wrapper">

    @* --- 左侧：评估要点列表 --- *@
    <div class="col-md-3 sidebar-panel">
        @* Header: 高度与右侧一致 (需求 4) *@
        <div class="section-header">
            <div class="fw-bold text-dark d-flex align-items-center">
                <i class="fa fa-list-check me-2 text-primary"></i>
                <span>评估要点列表</span>
            </div>
        </div>

        @* Tree List *@
        <div class="flex-grow-1 tree-container custom-scroll">
            @if (IsLoading)
            {
                <div class="text-center mt-5"><Spinner Color="Color.Primary" /></div>
            }
            else if (TreeItems.Any())
            {
                <TreeView TItem="TaskNodeTreeDto"
                          Items="TreeItems"
                          OnTreeItemClick="OnNodeClick"
                          ShowIcon="false"
                          ClickToggleNode="false" />
            }
            else
            {
                <div class="text-center mt-5 text-muted small">暂无数据</div>
            }
        </div>
    </div>

    @* --- 右侧：详情填报区 --- *@
    <div class="col-md-9 content-panel">
        @if (CurrentNodeDetail != null)
        {
            @* 1. 顶部：Title Header (需求 4) *@
            <div class="section-header justify-content-between" style="z-index: 2;">
                <div class="d-flex align-items-center overflow-hidden">
                    <span class="badge bg-primary me-3 rounded-pill px-3">当前要点</span>
                    <h5 class="fw-bold text-dark mb-0 text-truncate" title="@CurrentNodeDetail.PointName">
                        @CurrentNodeDetail.PointName
                    </h5>
                </div>
                <div class="d-flex align-items-center ms-3">
                    <div class="text-end me-2">
                        <small class="text-muted d-block" style="font-size: 0.7rem;">标准分</small>
                        <span class="fw-bold text-dark h5 mb-0">@CurrentNodeDetail.MaxScore</span>
                    </div>
                </div>
            </div>

            @* 2. 中间：可滚动内容区 *@
            <div class="flex-grow-1 detail-scroll-area custom-scroll">

                @* 驳回警告 *@
                @if (CurrentNodeDetail.Status == AuditStatus.Rejected)
                {
                    <div class="alert alert-danger border-0 shadow-sm mb-4 d-flex align-items-start">
                        <i class="fa fa-circle-exclamation me-3 mt-1 fa-lg"></i>
                        <div>
                            <strong class="d-block mb-1">此项已被驳回</strong>
                            <span>@CurrentNodeDetail.RejectReason</span>
                        </div>
                    </div>
                }

                @* (A) 指标归属路径 *@
                <div class="task-card p-4">
                    <div class="card-title-line">
                        <i class="fa fa-sitemap me-2 text-primary"></i> 指标归属
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="indicator-pill">
                                <span class="indicator-label">一级指标</span>
                                <div class="indicator-content">@CurrentNodeDetail.FirstIndicator</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="indicator-pill">
                                <span class="indicator-label">二级指标</span>
                                <div class="indicator-content">@CurrentNodeDetail.SecondIndicator</div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="indicator-pill bg-primary bg-opacity-10 border-primary border-opacity-25">
                                <span class="indicator-label text-primary text-opacity-75">评估参考点</span>
                                <div class="indicator-content text-primary">@CurrentNodeDetail.ReferencePoint</div>
                            </div>
                        </div>
                    </div>
                </div>

                @* (B) 评估方法 *@
                <div class="task-card p-4">
                    <div class="card-title-line">
                        <i class="fa fa-book-open me-2 text-info"></i> 评估方法
                    </div>
                    <div class="text-secondary lh-lg" style="white-space: pre-wrap;">@CurrentNodeDetail.Method</div>
                </div>

                @* (C) 评分标准细则 *@
                <div class="task-card p-4">
                    <div class="card-title-line">
                        <i class="fa fa-scale-balanced me-2 text-warning"></i> 评分标准
                    </div>
                    @if (CurrentNodeDetail.ScoringItems != null && CurrentNodeDetail.ScoringItems.Any())
                    {
                        <div class="table-responsive rounded border">
                            <table class="table table-hover mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="text-center py-3 text-muted border-bottom-0" style="width: 80px;">等级</th>
                                        <th class="text-center py-3 text-muted border-bottom-0" style="width: 80px;">系数</th>
                                        <th class="py-3 text-muted border-bottom-0">评分描述</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in CurrentNodeDetail.ScoringItems)
                                    {
                                        <tr>
                                            <td class="text-center fw-bold align-middle bg-light text-dark">@item.LevelCode</td>
                                            <td class="text-center font-monospace align-middle text-muted">@item.Ratio</td>
                                            <td class="align-middle text-secondary py-3">@item.Description</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-muted small fst-italic">暂无详细评分标准表</div>
                    }
                </div>

                @* (D) 自评填报区 *@
                <div class="task-card p-0 overflow-hidden border border-success border-2">
                    <div class="bg-success bg-opacity-10 p-3 border-bottom border-success border-opacity-25 text-success fw-bold">
                        <i class="fa fa-pen-to-square me-2"></i> 自评填报
                    </div>
                    <div class="p-4">
                        <div class="mb-4">
                            <label class="form-label fw-bold text-secondary mb-2">自评说明</label>
                            <Textarea @bind-Value="CurrentNodeDetail.MyContent" Rows="5"
                                      Placeholder="请根据上述标准，详细描述落实情况..."
                                      class="border-0 bg-light rounded p-3" />
                        </div>
                        <div class="evidence-upload-wrapper p-3 border-dashed rounded-3 bg-light">
    <div class="mb-2 small text-muted">
        <i class="fa-solid fa-circle-info me-1"></i>
        请拖拽或点击上传 PDF 佐证材料（支持多文件，单文件不超过 20MB）
    </div>

    @* Bootstrap Blazor 拖拽上传组件 *@
    <DropUpload TValue="string" 
                Accept=".pdf" 
                OnUploadAsync="@OnDropUpload" 
                OnDelete="@OnDeleteFile"
                DefaultFileList="@UploadedFiles" />
</div>
                    </div>
                </div>

                @* 底部留白 *@
                <div style="height: 20px;"></div>
            </div>

            @* 3. 底部：固定操作栏 *@
<div class="action-footer">
    @if (CurrentNodeDetail != null)
    {
        @if (IsNodeEditable)
        {
            <Button Color="Color.Primary" Icon="fa fa-floppy-disk" Text="保存并提交此项"
                    OnClick="OnSaveEvidence" IsAsync="true"
                    class="px-5 shadow rounded-pill fw-bold" />
        }
        else
        {
             <span class="text-muted bg-light px-3 py-2 rounded-pill border">
                @if (CurrentTaskStatus == TaskStatu.Returned)
                {
                    <i class="fa fa-lock me-1"></i> <span>该节点未被驳回，无需修改</span>
                }
                else if (!IsEditable)
                {
                    <i class="fa fa-clock me-1"></i> <span>非填报时间或已完结，仅供查看</span>
                }
            </span>
        }
    }
</div>
        }
        else
        {
            @* 空状态 *@
            <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                <div class="bg-white p-5 rounded-circle shadow-sm mb-4">
                    <i class="fa fa-arrow-left fa-3x text-primary opacity-25"></i>
                </div>
                <h5 class="fw-light">请从左侧选择一个评估要点开始填报</h5>
            </div>
        }
    </div>
</div>
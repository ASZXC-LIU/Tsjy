@page "/Admin/TaskDistribute"
@using Tsjy.Application.System.Dtos.BatchDtos
@using Tsjy.Core.Enums
@inherits BootstrapComponentBase
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "Admin")]
@namespace Tsjy.Web.Entry.Pages.Admin

<div class="container-fluid page-wrapper animate__animated animate__fadeInUp">
    <div class="card modern-card">
        <div class="card-accent"></div>

        <ValidateForm Model="@Model" OnValidSubmit="@OnValidSubmit">

            <div class="form-header">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h1 class="header-title">
                            @(Model.Id > 0 ? "编辑任务" : "创建新任务")
                        </h1>
                        <div class="header-subtitle">
                            请配置下方的考评任务详情及各阶段时间节点。
                        </div>
                    </div>
                    <div class="d-none d-md-block text-primary opacity-10">
                        <i class="fa-solid fa-paper-plane fa-3x"></i>
                    </div>
                </div>
            </div>

            <div class="form-body">
                @* 1. 基础信息 *@
                <div class="row g-5 mb-4">
                    <div class="col-12">
                        <label class="custom-label">
                            <i class="fa-solid fa-heading"></i> 任务名称
                        </label>
                        <BootstrapInput @bind-Value="@Model.Name"
                                        ShowLabel="false"
                                        Placeholder="请输入任务名称，例如：2025年度特殊教育学校春季考评"
                                        class="form-control-lg shadow-none" />
                    </div>
                </div>

                @* 2. 时间流程配置 (核心修改) *@
                <div class="section-divider">
                    <span class="section-tag">流程时间配置</span>
                </div>

                <div class="row g-4">
                    @* 第一阶段：单位填报 *@
                    <div class="col-12 col-md-4">
                        <div class="time-card bg-light-primary p-3 rounded-3 border h-100">
                            <h6 class="text-primary fw-bold mb-3"><i class="fa-solid fa-upload me-2"></i>第一阶段：单位填报</h6>
                            <div class="mb-3">
                                <label class="small text-muted mb-1">开始时间</label>
                                <DateTimePicker @bind-Value="@Model.UploadStart" ShowLabel="false" />
                            </div>
                            <div>
                                <label class="small text-muted mb-1">截止时间</label>
                                <DateTimePicker @bind-Value="@Model.UploadEnd" ShowLabel="false" />
                            </div>
                        </div>
                    </div>

                    @* 第二阶段：专家评审 *@
                    <div class="col-12 col-md-4">
                        <div class="time-card bg-light-warning p-3 rounded-3 border h-100">
                            <h6 class="text-warning fw-bold mb-3" style="color:#d97706 !important"><i class="fa-solid fa-gavel me-2"></i>第二阶段：专家评审</h6>
                            <div class="mb-3">
                                <label class="small text-muted mb-1">开始时间</label>
                                <DateTimePicker @bind-Value="@Model.ReviewStart" ShowLabel="false" />
                            </div>
                            <div>
                                <label class="small text-muted mb-1">截止时间</label>
                                <DateTimePicker @bind-Value="@Model.ReviewEnd" ShowLabel="false" />
                            </div>
                        </div>
                    </div>

                    @* 第三阶段：视导巡视 *@
                    <div class="col-12 col-md-4">
                        <div class="time-card bg-light-success p-3 rounded-3 border h-100">
                            <h6 class="text-success fw-bold mb-3"><i class="fa-solid fa-car-side me-2"></i>第三阶段：视导巡视</h6>
                            <div class="mb-3">
                                <label class="small text-muted mb-1">开始时间</label>
                                <DateTimePicker @bind-Value="@Model.InspectionStart" ShowLabel="false" />
                            </div>
                            <div>
                                <label class="small text-muted mb-1">截止时间</label>
                                <DateTimePicker @bind-Value="@Model.InspectionEnd" ShowLabel="false" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-divider mt-5">
                    <span class="section-tag">关联配置</span>
                </div>

                <div class="row g-5">
                    @* 机构类型 *@
                    <div class="col-12 col-md-6">
                        <label class="custom-label">
                            <i class="fa-solid fa-school"></i> 适用机构
                        </label>
                        <Select TValue="OrgType?"
                                Value="@Model.TargetType"
                                ValueChanged="@OnOrgTypeChanged"
                                Items="@OrgTypeItems"
                                ShowLabel="false"
                                PlaceHolder="请选择..."
                                class="shadow-none" />
                        <div class="small text-muted mt-2 ps-1">
                            <i class="fa-solid fa-arrow-turn-up me-1"></i> 选择后自动加载右侧体系
                        </div>
                    </div>

                    @* 评价体系 *@
                    <div class="col-12 col-md-6">
                        <label class="custom-label @(Model.TargetType.HasValue ? "text-primary" : "")">
                            <i class="fa-solid fa-tree"></i> 评价体系
                        </label>
                        <Select @bind-Value="@Model.TreeId"
                                Items="@TreeItems"
                                ShowLabel="false"
                                PlaceHolder="@(Model.TargetType.HasValue ? "请选择体系..." : "🚫 请先选择左侧机构类型")"
                                IsDisabled="@(!Model.TargetType.HasValue)"
                                class="shadow-none" />

                        @if (Model.TreeId > 0)
                        {
                            <div class="small text-success mt-2 ps-1 animate__animated animate__fadeIn">
                                <i class="fa-solid fa-check-circle me-1"></i> 已关联有效体系
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="form-footer">
                @if (OnClose != null)
                {
                    <Button Color="Color.None" class="text-secondary fw-bold px-4" OnClick="() => OnClose.Invoke()">
                        取消
                    </Button>
                }
                <Button ButtonType="ButtonType.Submit"
                        Color="Color.Primary"
                        class="px-5 py-2 rounded-pill shadow-sm fw-bold">
                    <i class="fa-solid fa-floppy-disk me-2"></i> 保存配置
                </Button>
            </div>

        </ValidateForm>
    </div>
</div>
<AuthorizeView>
    <div class="alert alert-warning mt-4">
        <h4>权限调试面板</h4>
        @* 在 AuthorizeView 内部，context 变量自动存在 *@
        <p>当前登录状态: <b>@(context.User.Identity?.IsAuthenticated == true ? "已登录" : "未登录")</b></p>
        <p>当前用户名: <b>@context.User.Identity?.Name</b></p>
        <p>拥有的权限(Claims):</p>
        <ul>
            @foreach (var claim in context.User.Claims)
            {
                <li>Type: @claim.Type <br /> Value: <b>@claim.Value</b></li>
            }
        </ul>
    </div>
</AuthorizeView>
<style>
    .bg-light-primary {
        background-color: #f0f7ff;
        border-color: #bae0ff !important;
    }

    .bg-light-warning {
        background-color: #fffbe6;
        border-color: #ffe58f !important;
    }

    .bg-light-success {
        background-color: #f6ffed;
        border-color: #b7eb8f !important;
    }
</style>
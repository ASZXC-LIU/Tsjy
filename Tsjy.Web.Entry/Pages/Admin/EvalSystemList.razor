@page "/Admin/EvalSystemList"
@using Tsjy.Application.System.Dtos
@using Tsjy.Core.Entities
@attribute [Authorize(Roles = "ADMIN")]
@inherits BootstrapComponentBase
@namespace Tsjy.Web.Entry.Pages.Admin

<PageTitle>评价体系列表</PageTitle>

<div class="container-fluid pt-3">

    @* --- 顶栏：类型选择 --- *@
    <div class="d-flex align-items-center mb-3">
        <span class="text-secondary me-3 fw-bold">选择体系类型:</span>
        <Select @bind-Value="CurrentCategory" Items="CategoryOptions" OnSelectedItemChanged="OnCategoryChanged" class="w-auto" />
    </div>

    @* --- 表格展示区 --- *@
    @* 绑定 ref 以便从 CS 文件中调用 QueryAsync *@
    <Table TItem="EvalSystemListDto"
           @ref="SystemTable" 
           IsPagination="true" IsStriped="true" IsBordered="true"
           ShowToolbar="true"
           ShowExtendButtons="true"
           ExtendButtonColumnWidth="200"
           ShowDefaultButtons="false"
           ShowAddButton="false"
           ShowEditButton="false"
           ShowDeleteButton="false"
           OnQueryAsync="OnQueryAsync">

        <TableToolbarTemplate>
            <div class="d-flex justify-content-between align-items-center w-100">
                <h5 class="m-0 fw-bold text-primary">@CategoryOptions.FirstOrDefault(x => x.Value == CurrentCategory)?.Text</h5>
                <Button Color="Color.Success" Icon="fa-solid fa-sitemap" Text="新建评价体系" OnClick="OnCreateSystem" />
            </div>
        </TableToolbarTemplate>

        <TableColumns>
            <TableColumn @bind-Field="@context.Name" Text="体系名称" />
            <TableColumn @bind-Field="@context.Category" Text="类型代号" Width="180" />
            <TableColumn @bind-Field="@context.CreatedAt" Text="创建时间" FormatString="yyyy-MM-dd HH:mm" Width="180" />
            
            <TableColumn @bind-Field="@context.UpdatedAt" Text="更新时间" FormatString="yyyy-MM-dd HH:mm" Width="180" />
            
            <TableColumn @bind-Field="@context.IsDeleted" Text="是否启用" Width="180" />
        </TableColumns>

        <RowButtonTemplate>
            @* 编辑/跳转到 Builder 按钮 *@
            <Button Size="Size.ExtraSmall" Color="Color.Primary" Icon="fa-solid fa-edit" Text="编辑/构建" OnClick="() => OnEditSystem(context)" />

            @* 删除按钮 *@
            <PopConfirmButton Placement="Placement.Left" Color="Color.Danger" Icon="fa-solid fa-trash-alt" Text="删除"
                              ConfirmButtonText="确认删除"
                              Content="确认删除该体系及其所有指标吗？"
                              OnConfirm="() => OnDelete(context)" />
        </RowButtonTemplate>
    </Table>
</div>
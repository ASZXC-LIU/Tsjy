@page "/Admin/BatchManagement"
@using Tsjy.Application.System.Dtos.BatchDtos
@using Tsjy.Core.Entities
@using Tsjy.Core.Enums
@attribute [Authorize(Roles = "Admin")]
@inherits BootstrapComponentBase
@namespace Tsjy.Web.Entry.Pages.Admin

<div class="container-fluid page-wrapper animate__animated animate__fadeIn">
    <div class="card modern-card">
        @* 顶部装饰 *@
        <div class="card-accent"></div>

        @* 1. 头部标题与新建按钮 *@
        <div class="page-header">
            <div>
                <h1 class="header-title">批次任务管理</h1>
                <div class="header-subtitle">
                    <i class="fa-solid fa-list-check me-1"></i> 管理所有评估任务批次，监控发布状态
                </div>
            </div>
            <div>
                <Button Color="Color.Primary" Icon="fa-solid fa-plus" class="px-4 py-2 rounded-pill shadow-sm fw-bold" OnClick="@OnAdd">
                    新建批次
                </Button>
            </div>
        </div>

        @* 2. 表格组件 *@
        <Table TItem="BatchListDto"
               @ref="Table"
               IsPagination="true"
               IsStriped="false"
               IsBordered="false"
               IsHover="true"
               ShowToolbar="false"
               ShowSearch="true"
               ShowExtendButtons="true"
               ShowSkeleton="true"
               OnQueryAsync="@OnQueryAsync">

            @* 3. 自定义搜索区 *@
            <SearchTemplate>
                <div class="search-section">
                    <div class="row g-4">
                        @* 批次名称搜索 *@
                        <div class="col-12 col-md-4">
                            <label class="custom-label">
                                <i class="fa-solid fa-magnifying-glass"></i> 批次名称
                            </label>
                            <BootstrapInput @bind-Value="@context.Name"
                                            ShowLabel="false"
                                            Placeholder="输入名称模糊查询..."
                                            class="search-input shadow-none" />
                        </div>

                        @* 批次类型搜索 *@
                        <div class="col-12 col-md-4">
                            <label class="custom-label">
                                <i class="fa-solid fa-filter"></i> 批次类型
                            </label>
                            @* ★★★ 修复 CS1662：TValue 必须与 BatchListDto.TargetType (OrgType) 类型完全一致 ★★★ *@
                            <Select TValue="OrgType"
                                    @bind-Value="@context.TargetType"
                                    Items="@OrgTypeItems"
                                    ShowLabel="false"
                                    PlaceHolder="全部类型"
                                    class="search-input shadow-none" />
                        </div>

                        @* 按钮组 *@
                        <div class="col-12 col-md-4 d-flex align-items-end">
                            <Button Color="Color.Primary" Icon="fa-solid fa-magnifying-glass" class="me-2 rounded-3 px-3" OnClick="@OnSearch">查询</Button>
                            <Button Color="Color.Light" Icon="fa-solid fa-rotate-right" class="rounded-3 px-3 text-secondary" OnClick="@OnReset">重置</Button>
                        </div>
                    </div>
                </div>
            </SearchTemplate>

            @* 4. 表格列定义 *@
            <TableColumns>
                <TableColumn @bind-Field="@context.Name" Text="任务名称" Width="250">
                    <Template Context="value">
                        <div class="d-flex align-items-center">
                            <div class="bg-light text-primary rounded p-2 me-3">
                                <i class="fa-solid fa-folder-open"></i>
                            </div>
                            <div>
                                <div class="fw-bold">@value.Row.Name</div>
                                <small class="text-muted">ID: @value.Row.Id</small>
                            </div>
                        </div>
                    </Template>
                </TableColumn>

                <TableColumn @bind-Field="@context.TargetType" Text="适用机构" Width="150" />

                <TableColumn @bind-Field="@context.StartAt" Text="开始时间" FormatString="yyyy-MM-dd" Width="120" />

                <TableColumn @bind-Field="@context.DueAt" Text="截止时间" FormatString="yyyy-MM-dd" Width="120">
                    <Template Context="value">
                        @if (value.Row.DueAt < DateTime.Now)
                        {
                            <span class="text-danger fw-bold">
                                <i class="fa-solid fa-circle-exclamation me-1"></i>已截止
                            </span>
                        }
                        else
                        {
                            <span class="text-success">
                                <i class="fa-regular fa-clock me-1"></i>
                                @(value.Value.HasValue? value.Value.Value.ToString("yyyy-MM-dd") : "-")
                            </span>
                        }
                    </Template>
                </TableColumn>

                @* ★★★ 修复 CS0411：添加 @bind-Field="@context.Id" 让编译器能推断类型 ★★★ *@
                <TableColumn @bind-Field="@context.Id" Text="操作" Align="Alignment.Center" Width="180">
                    <Template Context="value">
                        <div class="btn-icon-group">
                            <Button Color="Color.None" Icon="fa-solid fa-pen-to-square text-primary" TooltipText="编辑" OnClick="@(() => OnEdit(value.Row))" />
                            <Button Color="Color.None" Icon="fa-solid fa-trash-can text-danger" TooltipText="删除" OnClick="@(() => OnDelete(value.Row))" />
                        </div>
                    </Template>
                </TableColumn>
            </TableColumns>
        </Table>
    </div>
</div>
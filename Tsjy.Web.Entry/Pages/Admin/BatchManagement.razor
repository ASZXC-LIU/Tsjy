@page "/Admin/BatchManagement"
@using Tsjy.Application.System.Dtos.BatchDtos
@using Tsjy.Core.Entities
@using Tsjy.Core.Enums
@attribute [Authorize(Roles = "Admin")]
@inherits BootstrapComponentBase
@namespace Tsjy.Web.Entry.Pages.Admin

<div class="container-fluid page-wrapper animate__animated animate__fadeIn">
    <div class="card modern-card">
        @* 顶部装饰 *@
        <div class="card-accent"></div>

        @* 1. 头部标题 *@
        <div class="page-header">
            <div>
                <h1 class="header-title">批次任务管理</h1>
                <div class="header-subtitle">
                    <i class="fa-solid fa-list-check me-1"></i> 管理所有评估任务批次，监控发布状态
                </div>
            </div>
            <div>
                <Button Color="Color.Primary" Icon="fa-solid fa-plus" class="px-4 py-2 rounded-pill shadow-sm fw-bold" OnClick="@OnAdd">
                    新建批次
                </Button>
            </div>
        </div>

        @* 2. 自定义搜索区 (移出 Table，直接展示) *@
        <div class="search-section">
            <div class="row g-4">
                @* 批次名称搜索 *@
                <div class="col-12 col-md-4">
                    <label class="custom-label">
                        <i class="fa-solid fa-magnifying-glass"></i> 批次名称
                    </label>
                    <BootstrapInput @bind-Value="@SearchModel.Name"
                                    ShowLabel="false"
                                    Placeholder="输入名称模糊查询..."
                                    class="search-input shadow-none"
                                    OnEnterAsync="@(val => OnSearch())" />
                </div>

                @* 批次类型搜索 (功能接入点) *@
                <div class="col-12 col-md-4">
                    <label class="custom-label">
                        <i class="fa-solid fa-filter"></i> 批次类型
                    </label>
                    <Select TValue="OrgType?"
                            @bind-Value="@SearchModel.TargetType"
                            Items="@OrgTypeItems"
                            ShowLabel="false"
                            PlaceHolder="全部类型"
                            class="search-input shadow-none" />
                </div>

                @* 按钮组 *@
                <div class="col-12 col-md-4 d-flex align-items-end">
                    <Button Color="Color.Primary" Icon="fa-solid fa-magnifying-glass" class="me-2 rounded-3 px-3 shadow-sm" OnClick="@OnSearch">查询</Button>
                    <Button Color="Color.Light" Icon="fa-solid fa-rotate-right" class="rounded-3 px-3 text-secondary" OnClick="@OnReset">重置</Button>
                </div>
            </div>
        </div>

        @* 3. 表格组件 *@
        <Table TItem="BatchListDto"
               @ref="Table"
               IsPagination="true"
               IsStriped="false"
               IsBordered="false"
               IsHover="true"
               ShowToolbar="false"
               ShowSearch="false"
               ShowExtendButtons="false"
               ShowSkeleton="true"
               OnQueryAsync="@OnQueryAsync">

            <TableColumns>
                <TableColumn @bind-Field="@context.Name" Text="任务名称" Width="250">
                    <Template Context="value">
                        <div class="d-flex align-items-center">
                            <div class="bg-light text-primary rounded p-2 me-3">
                                <i class="fa-solid fa-folder-open"></i>
                            </div>
                            <div>
                                <div class="fw-bold">@value.Row.Name</div>
                                <small class="text-muted">ID: @value.Row.Id</small>
                            </div>
                        </div>
                    </Template>
                </TableColumn>

                <TableColumn @bind-Field="@context.TargetType" Text="适用机构" Width="150" />

                <TableColumn @bind-Field="@context.Status" Text="状态" Width="100" Align="Alignment.Center">
                    <Template Context="value">
                        @switch (value.Row.Status)
                        {
                            case PublicStatus.NotStarted:
                                <Tag Color="Color.Secondary">未发布</Tag>
                                break;
                            case PublicStatus.Published:
                                <Tag Color="Color.Success">已发布</Tag>
                                break;
                            case PublicStatus.InProgress:
                                <Tag Color="Color.Primary">进行中</Tag>
                                break;
                            case PublicStatus.Finished:
                                <Tag Color="Color.Dark">已结束</Tag>
                                break;
                        }
                    </Template>
                </TableColumn>

                @* ★★★ 修改 2: 时间安排按钮 (替换原有的 StartAt/DueAt) ★★★ *@
                <TableColumn @bind-Field="@context.Id" Text="时间安排" Align="Alignment.Center" Width="120">
                    <Template Context="value">
                        <Button Color="Color.Info"
                                IsOutline="true"
                                Size="Size.ExtraSmall"
                                Icon="fa-regular fa-clock"
                                Text="查看排期"
                                OnClick="@(() => ShowScheduleInfo(value.Row))" />
                    </Template>
                </TableColumn>

                @* ★★★ 修改 3: 操作列 (根据状态显示分发按钮) ★★★ *@
                <TableColumn @bind-Field="@context.Id" Text="操作" Align="Alignment.Center" Width="180">
                    <Template Context="value">
                        <div class="btn-icon-group">
                            @* 只有“未开始”状态才显示分发按钮 *@
                            @if (value.Row.Status == PublicStatus.NotStarted)
                            {
                                <Button Color="Color.None"
                                        Icon="fa-solid fa-paper-plane text-success"
                                        TooltipText="任务分发"
                                        OnClick="@(() => OnDistribute(value.Row))" />
                            }
                            else
                            {
                                @* 已发布后可以显示一个禁用的图标或者提示 *@
                                <span class="text-muted me-2" title="任务已分发"><i class="fa-solid fa-check-circle"></i></span>
                            }

                            <Button Color="Color.None" Icon="fa-solid fa-pen-to-square text-primary" TooltipText="编辑" OnClick="@(() => OnEdit(value.Row))" />
                            <Button Color="Color.None" Icon="fa-solid fa-trash-can text-danger" TooltipText="删除" OnClick="@(() => OnDelete(value.Row))" />
                        </div>
                    </Template>
                </TableColumn>
            </TableColumns>
        </Table>
    </div>
</div>
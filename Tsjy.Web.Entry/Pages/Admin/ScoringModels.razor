@page "/Admin/ScoringModels"
@using Tsjy.Application.System.Dtos
@using Tsjy.Core.Entities
@attribute [Authorize(Roles = "ADMIN")]
@inherits BootstrapComponentBase
@namespace Tsjy.Web.Entry.Pages.Admin

<PageTitle>评分模板管理</PageTitle>

<div class="container-fluid p-3">
    @* 头部标题区 *@
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-1 fw-bold text-dark">评分标准模板</h4>
            <span class="text-muted small">定义不同指标的打分规则（如四级制、是非制等），供创建指标时调用。</span>
        </div>
    </div>

    @* 主表格卡片 *@
    <div class="card card-modern p-0">
        <Table TItem="ScoringModel"
               IsPagination="true"
               IsStriped="false"
               IsBordered="false"
               IsHover="true"
               ShowToolbar="true"
               ShowExtendButtons="true"
               ShowDefaultButtons="true"
               OnQueryAsync="OnQueryAsync"
               OnSaveAsync="OnSaveAsync"
               OnDeleteAsync="OnDeleteAsync"
               OnEditAsync="OnEditAsync">

            <TableColumns>
                <TableColumn @bind-Field="@context.Id" Width="80" IsVisible="false" />

                <TableColumn @bind-Field="@context.Name" Text="模板名称">
                    <Template Context="value">
                        <div class="fw-bold fs-6 text-primary">@value.Value</div>
                    </Template>
                </TableColumn>

                <TableColumn @bind-Field="@context.UpdatedAt" Text="最近更新" FormatString="yyyy-MM-dd HH:mm" Width="200" />

                @* 预览列：直观展示前几个等级 *@
                <TableColumn @bind-Field="@context.Items" Text="包含等级" Width="300">
                    <Template Context="value">
                        @if (value.Value != null)
                        {
                            <div class="d-flex gap-1">
                                @foreach (var item in value.Value.OrderByDescending(x => x.Ratio).Take(4))
                                {
                                    <span class="badge bg-light text-dark border">@item.LevelCode (@item.Ratio)</span>
                                }
                                @if (value.Value.Count > 4)
                                {
                                    <span class="badge bg-light text-muted">...</span>
                                }
                            </div>
                        }
                        else
                        {
                            <span class="badge bg-light text-muted">无</span>
                        }
                    </Template>
                </TableColumn>
            </TableColumns>

            <EditTemplate>
                <div class="row g-4 p-2">
                    <div class="col-12">
                        <label class="form-label fw-bold text-secondary">模板基本信息</label>
                        <BootstrapInput @bind-Value="@EditModel.Name" ShowLabel="false"
                                        placeholder="请输入模板名称（例如：标准四级制评分）"
                                        class="form-control-lg shadow-sm" />
                    </div>

                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label fw-bold text-secondary mb-0">评分等级配置</label>
                            <Button Color="Color.Success" Icon="fa fa-plus" Text="添加等级" IsOutline="true"
                                    OnClick="@OnAddItem" Size="Size.ExtraSmall" class="rounded-pill px-3" />
                        </div>

                        <div class="bg-light rounded-3 p-3 border">
                            @if (EditModel.Items != null && EditModel.Items.Any())
                            {
                                <div class="vstack gap-2">
                                    @for (var i = 0; i < EditModel.Items.Count; i++)
                                    {
                                        var item = EditModel.Items[i];
                                        var index = i;
                                        // 根据索引生成不同颜色，增加视觉辨识度
                                        var badgeClass = index switch { 0 => "bg-success", 1 => "bg-primary", 2 => "bg-warning text-dark", _ => "bg-danger" };

                                        <div class="d-flex align-items-center bg-white p-2 rounded shadow-sm border-start border-4 @(index == 0 ? "border-success" : (index == 1 ? "border-primary" : "border-secondary"))">

                                            @* 序号/等级 *@
                                            <div class="me-3 text-center" style="width: 40px;">
                                                <span class="badge rounded-circle @badgeClass" style="width: 32px; height: 32px; line-height: 24px; font-size: 14px;">
                                                    @((char)('A' + index))
                                                </span>
                                            </div>

                                            @* 系数 *@
                                            <div class="me-3" style="width: 120px;">
                                                <BootstrapInputNumber @bind-Value="@item.Ratio" Min="0" Max="1" Step="0.1" ShowLabel="true" DisplayText="得分系数" />
                                            </div>

                                            @* 描述 *@
                                            <div class="flex-grow-1 me-3">
                                                <BootstrapInput @bind-Value="@item.Description" ShowLabel="false" placeholder="在此输入该等级的评价标准描述（例如：完全符合要求）..." />
                                            </div>

                                            @* 删除 *@
                                            <div>
                                                <Button Icon="fa-solid fa-xmark" Color="Color.None" class="text-muted hover-danger"
                                                        OnClick="@(() => OnRemoveItem(item))" TooltipText="移除此等级" />
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div class="mt-3 alert alert-secondary bg-opacity-25 border-0 d-flex align-items-center py-2 px-3">
                                    <i class="fa-solid fa-circle-info me-2 text-primary"></i>
                                    <small class="text-muted">系统将自动根据<b>系数从大到小</b>分配 A、B、C... 等级代号。请确保系数不重复。</small>
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-5 text-muted dashed-border">
                                    <i class="fa-regular fa-folder-open fa-2x mb-2 opacity-50"></i>
                                    <p>暂无评分等级，请点击右上角按钮添加</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </EditTemplate>
        </Table>
    </div>
</div>

<style>
    /* 局部样式微调 */
    .card-modern {
        border: none;
        box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.05);
        border-radius: 0.75rem;
        overflow: hidden;
    }

    .hover-danger:hover {
        color: var(--bs-danger) !important;
        background: rgba(220, 53, 69, 0.1);
        border-radius: 50%;
    }

    .dashed-border {
        border: 2px dashed #dee2e6;
        border-radius: 0.5rem;
    }
</style>
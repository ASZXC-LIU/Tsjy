@page "/Admin/ScoringModels"
@using Tsjy.Application.System.Dtos
@using Tsjy.Core.Entities
@using Tsjy.Web.Entry.Shared
@attribute [Authorize(Roles = "ADMIN")]
@inherits BootstrapComponentBase
@namespace Tsjy.Web.Entry.Pages.Admin

<PageTitle>评分模板管理</PageTitle>

<div class="container-fluid page-container">
    @* 1. 头部区域：清晰的标题和解释 *@
    <div class="d-flex justify-content-between align-items-end mb-4 animate__animated animate__fadeInDown">
        <div>
            <h4 class="header-title">
                <i class="fa-solid fa-scale-balanced me-2 text-primary"></i>评分标准模板
            </h4>
            <div class="header-desc">
                在此定义通用的打分规则（如四级制、五级制），供后续创建评价指标时直接调用。
            </div>
        </div>
    </div>

    @* 2. 主卡片表格 *@
    <div class="card card-modern animate__animated animate__fadeInUp">
        <Table TItem="ScoringModel"
               IsPagination="true"
               PageItemsSource="new[] { 10, 20, 50 }"
               ShowPageInfo="true"

               IsStriped="false"
               IsBordered="false"
               IsHover="true"
               ShowToolbar="true"
               ShowExtendButtons="true"
               ShowDefaultButtons="true"
               ShowSearch="false"
               OnQueryAsync="OnQueryAsync"
               OnSaveAsync="OnSaveAsync"
               OnDeleteAsync="OnDeleteAsync"
               OnEditAsync="OnEditAsync"
               OnAddAsync="OnAddAsync">

            <TableColumns>
                <TableColumn @bind-Field="@context.Id" Width="60" IsVisible="false" />

                <TableColumn @bind-Field="@context.Name" Text="模板名称" Width="220">
                    <Template Context="value">
                        <div class="d-flex align-items-center">
                            @* 图标装饰 *@
                            <div class="symbol-circle">
                                <i class="fa-solid fa-cube fs-5"></i>
                            </div>
                            <div>
                                <div class="fw-bold text-dark fs-6">@value.Value</div>
                                <div class="small text-muted">包含 @(value.Row.Items?.Count ?? 0) 个等级</div>
                            </div>
                        </div>
                    </Template>
                </TableColumn>

                <TableColumn @bind-Field="@context.Items" Text="等级预览" Align="Alignment.Center">
                    <Template Context="value">
                        @if (value.Value != null && value.Value.Any())
                        {
                            <div class="d-flex flex-wrap gap-2 justify-content-center">
                                @* 仅展示前5个等级，避免表格过高 *@
                                @foreach (var item in value.Value.OrderByDescending(x => x.Ratio).Take(5))
                                {
                                    @* 使用 GetBadgeColor 方法动态获取颜色 *@
                                    <span class="badge rounded-pill badge-pill-custom border @GetBadgeColor(item.LevelCode)">
                                        @item.LevelCode <span class="opacity-50 mx-1">|</span> @(item.Ratio * 100)%
                                    </span>
                                }
                                @if (value.Value.Count > 5)
                                {
                                    <span class="badge rounded-pill bg-light text-secondary border">...</span>
                                }
                            </div>
                        }
                        else
                        {
                            <span class="text-muted small fst-italic">暂无定义</span>
                        }
                    </Template>
                </TableColumn>

                <TableColumn @bind-Field="@context.UpdatedAt" Text="最近更新" Width="180" FormatString="yyyy-MM-dd HH:mm" />
            </TableColumns>

            @* 3. 编辑弹窗：引导式设计 *@
            <EditTemplate>
                <div class="row g-4 px-2 py-2">
                    @* 步骤 1 *@
                    <div class="col-12">
                        <div class="step-header">
                            <span class="step-num">1</span>
                            <span class="step-title">基础信息</span>
                        </div>
                        <div class="ps-2">
                            <BootstrapInput @bind-Value="@EditModel.Name"
                                            ShowLabel="true"
                                            Label="模板名称"
                                            placeholder="例如：通用四级评分制 (优秀/良好/及格/不及格)"
                                            class="form-control-modern" />
                        </div>
                    </div>

                    @* 步骤 2 *@
                    <div class="col-12">
                        <div class="step-header">
                            <span class="step-num">2</span>
                            <span class="step-title">等级配置</span>
                        </div>

                        @* 引导提示 *@
                        <div class="guide-alert d-flex align-items-start mb-3 mx-2">
                            <i class="fa-solid fa-lightbulb text-warning fs-5 me-3 mt-1"></i>
                            <div>
                                <strong class="d-block text-dark">自动排序机制</strong>
                                <small class="text-secondary">
                                    系统将根据<b>系数 (Ratio)</b> 从大到小自动排序，并依次生成 <b>A、B、C...</b> 等级代码。
                                    <br />
                                    <i>建议：优秀填 1.0，不及格填 0。</i>
                                </small>
                            </div>
                        </div>

                        <div class="ps-2">
                            <ScoringLevelEditor @bind-Value="@EditModel.Items" />
                        </div>
                    </div>
                </div>
            </EditTemplate>
        </Table>
    </div>
</div>
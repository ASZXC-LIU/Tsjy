@using Tsjy.Web.Entry.Shared
@using Tsjy.Application.System.Dtos.BatchDtos
@using Tsjy.Core.Entities
@using Tsjy.Core.Enums
@inherits BootstrapComponentBase

<div class="batch-distribute-widget">
    <div class="step-container">
        <Step Items="@StepItems" @bind-Index="@CurrentStepIndex" IsIcon="true" />
    </div>

    <div class="content-body">
        @* 步骤 1: 选择单位 *@
        @if (CurrentStepIndex == 0)
        {
            <div class="animate__animated animate__fadeIn h-100">
                <div class="tip-alert">
                    <i class="fa-solid fa-school me-2"></i>
                    当前批次类型为 <strong>@BatchInfo?.TargetType.ToDescriptionString()</strong>
                </div>
                <Transfer Items="@OrgItems" @bind-Value="@SelectedOrgIdsStr" ShowSearch="true" Height="100%" LeftPanelText="可选单位" RightPanelText="已选单位" />
            </div>
        }

        @* 步骤 2: 视导组 *@
        @if (CurrentStepIndex == 1)
        {
            <div class="animate__animated animate__fadeIn h-100">
                <div class="tip-alert">
                    <i class="fa-solid fa-users-viewfinder me-2"></i> 选择视导组成员 (负责实地考察)
                </div>
                @if (!ExpertItems.Any())
                {
                    <div class="alert alert-danger shadow-sm">
                        <i class="fa-solid fa-triangle-exclamation me-2"></i> <strong>专家库为空！</strong> 请联系管理员添加专家。
                    </div>
                }
                else
                {
                    <Transfer Items="@ExpertItems" @bind-Value="@SelectedInspectionGroupStr" ShowSearch="true" Height="100%" LeftPanelText="专家库" RightPanelText="视导组" />
                }
            </div>
        }

        @* 步骤 3: 评审专家 (新界面) *@
        @if (CurrentStepIndex == 2)
        {
            <div class="animate__animated animate__fadeIn h-100">
                <div class="tip-alert">
                    <i class="fa-solid fa-scale-balanced me-2"></i>
                    <strong>随机平均分配模式：</strong> 系统将自动计算该体系的“评估要点”总数，并将其平均分配给您在下方选择的专家。
                </div>

                @if (!ExpertItems.Any())
                {
                    <div class="alert alert-danger shadow-sm">专家库为空，无法分配任务。</div>
                }
                else
                {
                    <Transfer Items="@ReviewExpertItems"
                              @bind-Value="@SelectedReviewExpertsStr"
                              ShowSearch="true"
                              Height="100%"
                              LeftPanelText="专家库"
                              RightPanelText="参与打分的专家" />
                }
            </div>
        }
    </div>

    <div class="widget-footer">
        <div class="text-muted small">
            @if (CurrentStepIndex == 2)
            {
                <span>已选打分专家: @SelectedReviewExpertsStr.Count 人</span>
            }
        </div>
        <div class="btn-group-action" style="margin-left: auto;">
            @if (CurrentStepIndex > 0)
            {
                <Button Color="Color.Secondary" Icon="fa-solid fa-arrow-left" Text="上一步" OnClick="@OnPrev" />
            }
            @if (CurrentStepIndex < StepItems.Count - 1)
            {
                <Button Color="Color.Primary" Icon="fa-solid fa-arrow-right" Text="下一步" OnClick="@OnNext" />
            }
            else
            {
                <Button Color="Color.Success" Icon="fa-solid fa-paper-plane" Text="确认发布" OnClick="@OnSubmit" IsAsync="true" />
            }
        </div>
    </div>
</div>